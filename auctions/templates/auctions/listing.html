{% extends "auctions/layout.html" %}
{% load static %}
{% load number_filters %}
{% load humanize %}

{% block additional_css %}
<link rel="stylesheet" href="{% static 'css/styles_CommentCard.css' %}">
{% endblock %}


{% block body %}

<div class="d-flex flex-row min-vh-100 h-100 w-100 justify-content-between">
        {% if messages %}
        <div class="messages position-fixed mt-3 start-50 translate-middle-x" style="z-index: 1500;">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show custom-alert" role="alert">
                    {{ message }}
                    <button class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
        {% endif %}

        <div id="messages-container" class="position-fixed start-50 translate-middle-x" style="z-index: 1500;">
        </div>

        <div class="side-animated-border border-right-light"></div>
        <div class="container pt-5 px-0" style="background-color: rgba(172, 255, 47, 0);">
            <div class="d-flex flex-column gap-1 mb-4 user-select-none">
                {% if listing.winner == request.user %}
                <div class="d-flex flex-column bg-dark text-white p-3 mx-3 align-items-center rounded" style="border: 1px solid var(--color-outline-light)">
                    <h5 class="p-0 mb-3 fw-bold">Congratulations!</h5>
                    <h6 class="p-0 m-0">you won this listing.</h6>
                </div>
                {% endif %}
                {% if listing.is_active == False %}
                <div class="d-flex flex-column p-2 mx-3 align-items-center rounded" style="border: 1px solid var(--color-outline-light)">
                    <h6 class="p-0 my-2">This listing has been closed</h6>
                </div>
                {% endif %}
            </div>

            <div class="breadcrumb mx-3">
                {% for cat in breadcrumb %}
                    <a class="me-2 fw-bold text-black" href="{% url 'categories'%}?categoryId={{cat.id}}">{{ cat.name }}</a>
                    {% if not forloop.last %}
                    <span class="me-2">
                        <svg style="width: 1rem; height: 1rem; margin-inline: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </span>
                    {% endif %}
                {% endfor %}
            </div>

            <div class="row g-3 mx-auto mb-5" style="max-width: 1400px; background-color: rgba(223, 226, 43, 0);">
                <div class="col-12 col-lg-6 d-flex flex-column py-3 px-3 mx-auto" style="max-width: 640px; background-color: rgba(38, 0, 128, 0);">
                                    <h2 class="mb-4 text-truncate-4" style="font-weight: 600;">
                        <span>
                            <svg width="20" height="17" viewBox="0 0 20 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.26 16.52V14.8H5.5V13.08H3.72V11.38H1.96V9.66H0.2V6.96H1.96V5.24H3.72V3.52H5.5V1.82H7.26V0.0999994H9.82V2.84H8.04V4.54H6.28V6.26H4.5V7.96H2.74V8.64H4.5V10.36H6.28V12.06H8.04V13.78H9.82V16.52H7.26ZM9.39219 16.52V13.78H11.1522V12.06H12.9322V10.36H14.6922V8.64H16.4722V7.96H14.6922V6.26H12.9322V4.54H11.1522V2.84H9.39219V0.0999994H11.9322V1.82H13.6922V3.52H15.4722V5.24H17.2122V6.96H19.0122V9.66H17.2122V11.38H15.4722V13.08H13.6922V14.8H11.9322V16.52H9.39219Z" fill="currentColor"/>
                            </svg>
                        </span>
                        {{ listing.title }}
                    </h2>
                    <div class="d-flex gap-1 gap-md-3 w-100 align-items-center mb-3" style="background-color: rgba(255, 0, 0, 0);">
                        <div class="profile-image" style="background-color: rgba(0, 0, 255, 0);">
                            <img
                                src="https://placehold.co/50x50"
                                class=""
                                alt=""
                                width="50px"
                                height="50px"
                                style="border-radius: 60px;"
                            />
                        </div>
                        <div class="d-flex flex-column w-100 p-0 mt-auto" style="background-color: rgba(0, 0, 255, 0);">
                            by
                            <br>
                            <h5 class="p-0 m-0" style="text-overflow: ellipsis;">{{listing.seller}}</h5>
                        </div>
                        <div class="d-flex mt-auto" style="background-color: rgba(0, 0, 255, 0);">
                            <div id="icon-wish-counter-container" class="d-flex flex-row gap-2 mr-3">
                                <p class="card-text favorites-count" style="margin: 0; padding: 0; font-size: 0.75rem; font-weight: 700;" data-favoritesCount="{{listing.favorites.count}}">{{listing.favorites.count|format_thousands:0}}</p>
                                <span class="d-flex align-items-center" style="width: 20px; height: 20px; color: #484848">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 21" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.99431 4.77985C8.32819 2.832 5.54981 2.30804 3.46227 4.09168C1.37472 5.87532 1.08083 8.85748 2.72019 10.967C4.0832 12.7209 8.20816 16.4201 9.5601 17.6174C9.71136 17.7513 9.78698 17.8183 9.8752 17.8446C9.95219 17.8676 10.0364 17.8676 10.1134 17.8446C10.2016 17.8183 10.2773 17.7513 10.4285 17.6174C11.7805 16.4201 15.9054 12.7209 17.2684 10.967C18.9078 8.85748 18.6498 5.85656 16.5264 4.09168C14.4029 2.3268 11.6604 2.832 9.99431 4.77985Z" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </span>
                            </div>
                            <div idclass="icon-comment-counter-container" class="d-flex flex-row gap-2">
                                <p class="card-text comments-count" style="margin: 0; padding: 0; font-size: 0.75rem; font-weight: 700;" data-commentsCount="{{listing.comments.count}}">{{listing.comments.count|format_thousands:0}}</p>
                                <span class="d-flex align-items-center" style="width: 20px; height: 20px; color: #484848">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 21" fill="none"><path d="M10 2C14.6944 2 18.5 5.80558 18.5 10.5C18.5 15.1944 14.6944 19 10 19C8.87131 19 7.79178 18.7792 6.80371 18.3779C6.73618 18.3505 6.69169 18.333 6.65918 18.3203C6.65442 18.3211 6.64913 18.3223 6.64355 18.3232L3.58496 18.833C3.44843 18.8558 3.27984 18.8844 3.13281 18.8955C2.98096 18.907 2.72313 18.9128 2.44824 18.7949C2.11437 18.6516 1.84834 18.3856 1.70508 18.0518C1.58717 17.7769 1.59303 17.519 1.60449 17.3672C1.61561 17.2202 1.64424 17.0516 1.66699 16.915L2.17676 13.8564C2.17771 13.8505 2.1789 13.8449 2.17969 13.8398C2.16701 13.8074 2.14926 13.7632 2.12207 13.6963C1.72083 12.7082 1.5 11.6287 1.5 10.5C1.5 5.80558 5.30558 2 10 2ZM7 10C6.44772 10 6 10.4477 6 11C6 11.5523 6.44772 12 7 12C7.55228 12 8 11.5523 8 11C8 10.4477 7.55228 10 7 10ZM10 10C9.44772 10 9 10.4477 9 11C9 11.5523 9.44772 12 10 12C10.5523 12 11 11.5523 11 11C11 10.4477 10.5523 10 10 10ZM13 10C12.4477 10 12 10.4477 12 11C12 11.5523 12.4477 12 13 12C13.5523 12 14 11.5523 14 11C14 10.4477 13.5523 10 13 10Z" fill="currentColor"/></svg>
                                </span>
                        </div>
                        </div>
                    </div>
                    <div class="d-flex w-100 p-0 m-0 justify-content-center rounded" style="aspect-ratio: 1; background-color: rgb(196, 196, 196);">
                        <img
                            src="{{ listing.image_url }}"
                            class="img-fluid h-100"
                            alt="Image for {{ title }}"
                        
                            style="object-fit: contain; background-color: rgba(21, 255, 0, 0);"
                            />
                    </div>
                </div>
                <div class="col-12 col-lg-6 d-flex flex-column p-3 mx-auto" style="max-width: 640px; background-color: rgba(0, 128, 0, 0);">
                    <div>
                        <p class="fw-normal mb-1 w-100">{% if listing.is_active == False %}Final Bid{% elif listing.has_bids %}Current Bid{% else %}Starting Bid{% endif %} ({{listing.bids.count}} bids)</p>
                        <h1 class="fw-bold mb-4 w-100">${% if listing.has_bids %}{{ listing.highest_bid|intcomma }}{% else %}{{ listing.starting_bid|intcomma }}{% endif %}</h1>
                    </div>
                    {% if listing.is_active and listing.seller != request.user %}
                    <form class="mb-3" action="{% url 'listing' id=listing.id %}" method="post">
                    {% csrf_token %}
                        
                            <div class="form-group form-group-kyore">
                                {{ bid_form.amount }}
                                {% for error in bid_form.amount.errors %}
                                <div class="invalid-feedback">
                                    {{ error }}
                                </div>
                                {% endfor %}
                            </div>
                        
                        
                        <input class="btn btn-primary w-100 py-3 text" style="font-weight: 600;" name="submit_bid" type="submit" value="Place Bid" aria-label="Place bid button">
                    </form>
                    {% elif listing.is_active and listing.seller == request.user %}
                    <form class="mb-3" action="{% url 'listing' id=listing.id %}" method="post">
                        {% csrf_token %}
                        <input class="btn btn-primary w-100 py-3 text" style="font-weight: 600;" name="close_listing" type="submit" value="Close Listing" aria-label="Close listing button">
                    </form>
                    {% elif not listing.is_active and listing.seller == request.user %}
                    <form class="mb-3" action="{% url 'listing' id=listing.id %}" method="post">
                        {% csrf_token %}
                        <input class="btn btn-primary w-100 py-3 text" style="font-weight: 600;" name="reopen_listing" type="submit" value="Re-Open Listing" aria-label="Re-open listing button">
                    </form>
                    {% endif %}
                    <button 
                        class="btn btn-favorite py-2 {% if listing.id in favorited_listing_ids %}favorited{% else %}{% endif %}"
                        data-id="{{listing.id}}"
                        data-url="{% url 'favorite_listing' id=listing.id %}"
                        data-csrf="{{ csrf_token }}"
                        data-favorited="{% if listing.id in favorited_listing_ids %}true{% else %}false{% endif %}"
                        >
                        <span id="favorite-button-text" class="fw-semibold">{% if listing.id in favorited_listing_ids %}Remove from watchlist{% else %}Add to watchlist{% endif %}</span>
                    </button>
                    <div class="flex flex-column mt-4">
                        <h5>Description</h5>
                        {{ listing.description }}
                    </div>
                </div>
            </div>

            <hr>

            <div class="comment-card mx-auto mt-5 mb-4">
                <form class="comment-input-group" action="{% url 'listing' id=listing.id %}" method="post">
                    <div class="d-flex align-items-start mb-2">
                        {% csrf_token %}
                        <div class="profile-pic-container me-1">
                            <img src="https://placehold.co/50x50/" alt="Profile Picture" class="profile-pic">
                        </div>
                        {{ comment_form.comment }}
                    </div>

                    <div class="d-flex justify-content-end">
                        <button
                            type="submit"
                            class="btn btn-primary"
                            name="submit_comment"
                        >
                            Post Comment
                        </button>
                    </div>
                </form>
            </div>
            {% if comments %}
            <div class="d-flex flex-column align-items-center mb-5" style="background-color: rgba(255, 0, 0, 0);">
                {% for comment in comments %}
                <div class="d-flex w-100 mb-3 px-3" style="max-width: 600px; background-color: rgba(0, 128, 0, 0);">
                    <div class="profile-pic-container me-3" style="margin-top: 0.25rem;">
                        <img src="https://placehold.co/50x50/" alt="Profile Picture" class="profile-pic">
                    </div>
                    <div>
                        <h6 class="mb-1 p-0">{{ comment.commenter }}</h6>
                        <p class="m-0 p-0">{{ comment.comment }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="side-animated-border border-left-light"></div>
</div>

<!-- Add/Remove wishlist script -->
<script src="{% static 'js/toggleFavoritesFromListings.js' %}"></script>
<!-- Script to autoupdate text-area height from text input -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const textarea = document.querySelector('.comment-textarea');
        const commentInputGroup = document.querySelector('.comment-input-group');

        commentInputGroup.addEventListener('click', () => {
            textarea.focus();
        })
        textarea.addEventListener('input', () => {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        })
    })
</script>
{% endblock %}
