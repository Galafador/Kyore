{% extends "auctions/layout.html" %}
{% load static %}
{% load number_filters %}

{% block additional_css %}
    <link href="{% static 'css/styles_index.css' %}" rel="stylesheet">
{% endblock %}

{% block title %}
Index
{% endblock %}

{% block body %}
    <div id="messages-container" class="position-fixed start-50 translate-middle-x" style="z-index: 1500;">
    </div>

    <div class="d-flex flex-row w-100 gap-3 py-3">
        <div class="d-flex flex-row flex-grow">
            <div class="card-body d-flex flex-column py-2 justify-content-between listing-card-title sticky-top">
                <svg xmlns="http://www.w3.org/2000/svg" width="39" height="18" fill="none">
                    <path fill="currentColor" d="M7.48 17.1v-1.78H5.7v-1.8H3.88v-1.76H2.1V9.98H.3V7.76h1.8v-1.8h1.78V4.18H5.7V2.42h1.78V.619999H9.7V2.88H7.88v1.78H6.1v1.78H4.28V8.2h-1.8v1.3h1.8v1.78H6.1v1.78h1.78v1.78H9.7v2.26H7.48Zm1.61219 0v-2.26h1.80001v-1.78h1.8v-1.78h1.8V9.5h1.8V8.2h-1.8V6.44h-1.8V4.66h-1.8V2.88H9.09219V.619999h2.18001V2.42h1.8v1.76h1.82v1.78h1.78v1.8h1.82v2.22h-1.82v1.78h-1.78v1.76h-1.82v1.8h-1.8v1.78H9.09219Zm18.77221 0v-1.78h-1.78v-1.8h-1.82v-1.76h-1.78V9.98h-1.8V7.76h1.8v-1.8h1.78V4.18h1.82V2.42h1.78V.619999h2.22V2.88h-1.82v1.78h-1.78v1.78h-1.82V8.2h-1.8v1.3h1.8v1.78h1.82v1.78h1.78v1.78h1.82v2.26h-2.22Zm1.6122 0v-2.26h1.8v-1.78h1.8v-1.78h1.8V9.5h1.8V8.2h-1.8V6.44h-1.8V4.66h-1.8V2.88h-1.8V.619999h2.18V2.42h1.8v1.76h1.82v1.78h1.78v1.8h1.82v2.22h-1.82v1.78h-1.78v1.76h-1.82v1.8h-1.8v1.78h-2.18Z"/>
                </svg>

                <div class="container-fluid d-flex flex-column gap-2">
                    <h2 style="font-weight: 600;">Active <br> Listings</h2>
                    <p>See what the community <br> has to offer!</p>
                </div>
                
                <svg xmlns="http://www.w3.org/2000/svg" width="39" height="18" fill="none">
                    <path fill="currentColor" d="M7.48 17.1v-1.78H5.7v-1.8H3.88v-1.76H2.1V9.98H.3V7.76h1.8v-1.8h1.78V4.18H5.7V2.42h1.78V.619999H9.7V2.88H7.88v1.78H6.1v1.78H4.28V8.2h-1.8v1.3h1.8v1.78H6.1v1.78h1.78v1.78H9.7v2.26H7.48Zm1.61219 0v-2.26h1.80001v-1.78h1.8v-1.78h1.8V9.5h1.8V8.2h-1.8V6.44h-1.8V4.66h-1.8V2.88H9.09219V.619999h2.18001V2.42h1.8v1.76h1.82v1.78h1.78v1.8h1.82v2.22h-1.82v1.78h-1.78v1.76h-1.82v1.8h-1.8v1.78H9.09219Zm18.77221 0v-1.78h-1.78v-1.8h-1.82v-1.76h-1.78V9.98h-1.8V7.76h1.8v-1.8h1.78V4.18h1.82V2.42h1.78V.619999h2.22V2.88h-1.82v1.78h-1.78v1.78h-1.82V8.2h-1.8v1.3h1.8v1.78h1.82v1.78h1.78v1.78h1.82v2.26h-2.22Zm1.6122 0v-2.26h1.8v-1.78h1.8v-1.78h1.8V9.5h1.8V8.2h-1.8V6.44h-1.8V4.66h-1.8V2.88h-1.8V.619999h2.18V2.42h1.8v1.76h1.82v1.78h1.78v1.8h1.82v2.22h-1.82v1.78h-1.78v1.76h-1.82v1.8h-1.8v1.78h-2.18Z"/>
                </svg>
            </div>
        </div>
        <div class="d-flex flex-row flex-wrap w-100 gap-3 listing-card-container">
            {% for listing in active_listings %}
            <div 
                class="card listing-card position-relative" 
                data-id="{{ listing.id }}"
                data-csrf="{{csrf_token}}"
                data-url="{% url 'favorite_listing' listing.id %}"
                data-favorited="{% if listing.id in favorited_listing_ids %}true{% else %}false{% endif %}"
            >
                {% if user.is_authenticated %}
                <button 
                class="btn btn-favorite position-absolute top-0 end-0 m-2 p-2" style="z-index: 2;">
                    {% if listing.id in favorited_listing_ids %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.993 5.136c-2-2.338-5.333-2.966-7.838-.826s-2.858 5.719-.89 8.25c1.635 2.105 6.585 6.544 8.207 7.98.182.162.272.242.378.274a.504.504 0 0 0 .286 0c.106-.032.197-.112.378-.273 1.623-1.437 6.573-5.876 8.208-7.98 1.967-2.532 1.658-6.133-.89-8.251-2.549-2.118-5.84-1.512-7.839.826Z" clip-rule="evenodd"/>
                    </svg>
                    {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.993 5.136c-2-2.338-5.333-2.966-7.838-.826s-2.858 5.719-.89 8.25c1.635 2.105 6.585 6.544 8.207 7.98.182.162.272.242.378.274a.504.504 0 0 0 .286 0c.106-.032.197-.112.378-.273 1.623-1.437 6.573-5.876 8.208-7.98 1.967-2.532 1.658-6.133-.89-8.251-2.549-2.118-5.84-1.512-7.839.826Z" clip-rule="evenodd"/>
                    </svg>
                    {% endif %}
                </button>
                {% endif %}
                <img class="card-img-top" src="{% if listing.image_url %}{{listing.image_url}}{% else %}https://placehold.co/600x600{% endif %}" alt="Listing image for {{ listing.title }}" width="300" height="300" style="object-fit:contain; background-color: rgb(209, 209, 209);" />
                <div class="card-body p-3" style="height: 250px; background-color: rgba(0, 255, 170, 0);">
                    <h5 class="card-title text-truncate-2" style="font-weight: 600;">{{listing.title}}</h5>
                    <p class="card-text text-truncate-4" style="font-size: 0.875rem;">
                        {{ listing.description }}
                    </p>
                    <a href="{% url 'listing' id=listing.id %}" class="stretched-link"></a>
                </div>
                <div class="card-body px-3 d-flex align-items-center justify-content-center" style="background-color: rgba(0, 255, 76, 0);">
                    <div class="h-100 d-flex align-items-center justify-content-start" style="min-width: fit-content; background-color: rgba(255, 0, 0, 0);">
                        <p style="font-weight: 800; font-size: 1.75rem; padding: 0; margin: 0;">
                            $
                            {% if listing.has_bids %}
                            {{ listing.highest_bid|format_thousands_then_superscript:2 }}
                            {% else %}
                            {{ listing.starting_bid|format_thousands_then_superscript:2 }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="d-flex w-100 h-100 d-flex align-items-end justify-content-end gap-2" style="background-color: rgba(0, 0, 255, 0);">
                        <p class="card-text favorites-count" style="margin: 0; padding: 0; font-size: 0.75rem; font-weight: 700;" data-favoritesCount="{{listing.favorites.count}}">{{listing.favorites.count|format_thousands:0}}</p>
                        <span class="icon-user"></span>
                        <p class="card-text comments-count" style="margin: 0; padding: 0; font-size: 0.75rem; font-weight: 700;" data-commentsCount="{{listing.comments.count}}">{{listing.comments.count|format_thousands:0}}</p>
                        <span class="icon-user"></span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="card listing-card position-relative">
                <h4>Nothing to see here...</h4>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            messagesContainer = document.getElementById("messages-container")
            document.querySelectorAll(".listing-card").forEach(card => {
                const listingId = card.dataset.id
                const url = card.dataset.url
                const csrf = card.dataset.csrf
                let isFavorited = card.dataset.favorited === "true"
                const favoriteButton = card.querySelector(".btn-favorite")
                const favoritesCount = card.querySelector(".favorites-count")

                favoriteButton.addEventListener("click", () => {
                    console.log("favorite button is being clicked");
                    fetch(`${url}`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrf,
                            "Accept": "application/json",
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.favorited !== undefined) {
                            isFavorited = data.favorited;
                            favoriteButton.innerHTML = data.favorited ? 
                            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.993 5.136c-2-2.338-5.333-2.966-7.838-.826s-2.858 5.719-.89 8.25c1.635 2.105 6.585 6.544 8.207 7.98.182.162.272.242.378.274a.504.504 0 0 0 .286 0c.106-.032.197-.112.378-.273 1.623-1.437 6.573-5.876 8.208-7.98 1.967-2.532 1.658-6.133-.89-8.251-2.549-2.118-5.84-1.512-7.839.826Z" clip-rule="evenodd"/>
                            </svg>`
                            :
                            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.993 5.136c-2-2.338-5.333-2.966-7.838-.826s-2.858 5.719-.89 8.25c1.635 2.105 6.585 6.544 8.207 7.98.182.162.272.242.378.274a.504.504 0 0 0 .286 0c.106-.032.197-.112.378-.273 1.623-1.437 6.573-5.876 8.208-7.98 1.967-2.532 1.658-6.133-.89-8.251-2.549-2.118-5.84-1.512-7.839.826Z" clip-rule="evenodd"/>
                            </svg>`;

                            if (favoritesCount && data.favorites_count !== undefined) {
                                favoritesCount.innerHTML = data.favorites_count
                            }

                            if (data.message) {
                                console.log(data.message)
                                messagesContainer.innerHTML = "";
                                const alert = document.createElement('div')
                                alert.className = "alert alert-success alert-dismissible fade show";
                                alert.setAttribute("role", "alert")
                                alert.innerHTML = `
                                ${data.message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                `;

                                messagesContainer.appendChild(alert);

                                //auto-close after 3 seconds
                                setTimeout(() => {
                                    const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                                    bsAlert.close();
                                }, 3000);
                            }
                        }
                    })
                    .catch(error => console.error("AJAX error: ", error))
                })
            })
        })
    </script>
{% endblock %}