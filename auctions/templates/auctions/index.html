{% extends "auctions/layout.html" %}
{% load static %}
{% load number_filters %}

{% block additional_css %}
    <link href="{% static 'css/styles_index.css' %}" rel="stylesheet">
{% endblock %}

{% block title %}
Index
{% endblock %}

{% block body %}
    <div class="d-flex flex-row w-100 gap-3 py-4">
        <div class="d-flex flex-row flex-grow">
            <div class="card-body d-flex flex-column py-2 justify-content-between listing-card-title sticky-top">
                <span class="icon-user"></span>
                <div class="container-fluid d-flex flex-column gap-2">
                    <h2 style="font-weight: 600;">Active <br> Listings</h2>
                    <p>See what the community <br> has to offer!</p>
                </div>
                <span class="icon-user"></span>
            </div>
        </div>
        <div class="d-flex flex-row flex-wrap w-100 gap-3 listing-card-container">
            {% for listing in active_listings %}
            <div class="card listing-card position-relative" data-id="{{ listing.id }}">
                {% if user.is_authenticated %}
                <button 
                class="btn btn-favorite position-absolute top-0 end-0 m-2 p-2" 
                style="z-index: 2;" 
                data-favorited="{% if listing.id in favorited_listing_ids %}true{% else %}false{% endif %}"
                data-url="{% url 'favorite_listing' listing.id %}"
                data-csrf="{{csrf_token}}"
                >
                    {% if listing.id in favorited_listing_ids %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.993 5.136c-2-2.338-5.333-2.966-7.838-.826s-2.858 5.719-.89 8.25c1.635 2.105 6.585 6.544 8.207 7.98.182.162.272.242.378.274a.504.504 0 0 0 .286 0c.106-.032.197-.112.378-.273 1.623-1.437 6.573-5.876 8.208-7.98 1.967-2.532 1.658-6.133-.89-8.251-2.549-2.118-5.84-1.512-7.839.826Z" clip-rule="evenodd"/>
                    </svg>
                    {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.993 5.136c-2-2.338-5.333-2.966-7.838-.826s-2.858 5.719-.89 8.25c1.635 2.105 6.585 6.544 8.207 7.98.182.162.272.242.378.274a.504.504 0 0 0 .286 0c.106-.032.197-.112.378-.273 1.623-1.437 6.573-5.876 8.208-7.98 1.967-2.532 1.658-6.133-.89-8.251-2.549-2.118-5.84-1.512-7.839.826Z" clip-rule="evenodd"/>
                    </svg>
                    {% endif %}
                </button>
                {% endif %}
                <img class="card-img-top" src="{% if listing.image_url %}{{listing.image_url}}{% else %}https://placehold.co/600x600{% endif %}" alt="Listing image for {{ listing.title }}" width="300" height="300" style="object-fit:contain; background-color: rgb(209, 209, 209);" />
                <div class="card-body p-3" style="height: 250px; background-color: rgba(0, 255, 170, 0);">
                    <h5 class="card-title text-truncate-2" style="font-weight: 600;">{{listing.title}}</h5>
                    <p class="card-text text-truncate-4" style="font-size: 0.875rem;">
                        {{ listing.description }}
                    </p>
                    <a href="{% url 'listing' id=listing.id %}" class="stretched-link"></a>
                </div>
                <div class="card-body px-3 d-flex align-items-center justify-content-center" style="background-color: rgba(0, 255, 76, 0);">
                    <div class="h-100 d-flex align-items-center justify-content-start" style="min-width: fit-content; background-color: rgba(255, 0, 0, 0);">
                        <p style="font-weight: 800; font-size: 1.75rem; padding: 0; margin: 0;">
                            $
                            {% if listing.has_bids %}
                            {{ listing.highest_bid|format_thousands_then_superscript:2 }}
                            {% else %}
                            {{ listing.starting_bid|format_thousands_then_superscript:2 }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="d-flex w-100 h-100 d-flex align-items-end justify-content-end gap-2" style="background-color: rgba(0, 0, 255, 0);">
                        <p class="card-text" style="margin: 0; padding: 0; font-size: 0.75rem; font-weight: 700;">{{listing.favorites.count|format_thousands:0}}<span class="icon-user"></span></p>
                        <p class="card-text" style="margin: 0; padding: 0; font-size: 0.75rem; font-weight: 700;">{{listing.comments.count|format_thousands:0}}<span class="icon-user"></span></p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div style="height: 1000px"></div>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll("btn-favorite").forEach(button => {
                button.addEventListener("click", () => {
                    const listingCard = button.closest(".listing-card")
                    const listingId = listingCard.dataset.id
                    const url = button.dataset.url
                    const csrf = button.dataset.csrf
                    const isFavorited = button.dataset.favorited === "true"

                    fetch(`${url}`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrf,
                            "Accept": "application/json",
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.favorited !== undefined) {
                            button.dataset.favorited = data.favorited;
                            button.textContent = data.favorited ? 
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.993 5.136c-2-2.338-5.333-2.966-7.838-.826s-2.858 5.719-.89 8.25c1.635 2.105 6.585 6.544 8.207 7.98.182.162.272.242.378.274a.504.504 0 0 0 .286 0c.106-.032.197-.112.378-.273 1.623-1.437 6.573-5.876 8.208-7.98 1.967-2.532 1.658-6.133-.89-8.251-2.549-2.118-5.84-1.512-7.839.826Z" clip-rule="evenodd"/>
                            </svg>
                            :
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.993 5.136c-2-2.338-5.333-2.966-7.838-.826s-2.858 5.719-.89 8.25c1.635 2.105 6.585 6.544 8.207 7.98.182.162.272.242.378.274a.504.504 0 0 0 .286 0c.106-.032.197-.112.378-.273 1.623-1.437 6.573-5.876 8.208-7.98 1.967-2.532 1.658-6.133-.89-8.251-2.549-2.118-5.84-1.512-7.839.826Z" clip-rule="evenodd"/>
                            </svg>
                        }
                    })
                    .catch(error => console.error("Ajax error:", error))
                })
            })
        });
    </script>
    
    <!--    
    <ul>
        {% for active_listing in active_listings %}
        <li><a href="{% url 'listing' id=active_listing.id %}">{{ active_listing }}</a></li>
        {% empty %}
        <li>No active listings.</li>
        {% endfor %}
        </ul>
    </div>
    -->
{% endblock %}